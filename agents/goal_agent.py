from datetime import date, datetime, timedelta
from models.goal import GoalDraft

class GoalAgent:
    def __init__(self, llm):
        self.llm = llm

    def extract_goal(self, user_input: str) -> GoalDraft:
        today = date.today()
        year_end = f"{today.year}-12-31"
        
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ—Ä–æ–≤ —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –¥–∞—Ç–∞–º–∏
        in_2_weeks = (today + timedelta(weeks=2)).isoformat()
        in_1_month = (today.replace(day=1) + timedelta(days=32)).replace(day=1).isoformat()
        in_3_months = (today.replace(day=1) + timedelta(days=93)).replace(day=1).isoformat()
        
        # –ü—è—Ç–Ω–∏—Ü–∞ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏
        days_ahead = 4 - today.weekday()  # –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫=0, –ü—è—Ç–Ω–∏—Ü–∞=4
        if days_ahead < 0:
            days_ahead += 7
        next_friday = (today + timedelta(days=days_ahead)).isoformat()

        prompt = f"""
        –¢—ã ‚Äî —Å—Ç—Ä–æ–≥–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ü–µ–ª–µ–π. –°–ª–µ–¥—É–π –ø—Ä–∞–≤–∏–ª–∞–º –ë–ï–ó –ò–°–ö–õ–Æ–ß–ï–ù–ò–ô.

        –ò–∑–≤–ª–µ–∫–∏ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞:

        - **title**: —Ç–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤–∏–µ –∏ –æ–±—ä–µ–∫—Ç. –ù–ò–ö–ê–ö–ò–• —Å—Ä–æ–∫–æ–≤!
        –ü—Ä–∞–≤–∏–ª—å–Ω–æ: "–í—ã—É—á–∏—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π", "–ü—Ä–æ–±–µ–∂–∞—Ç—å –º–∞—Ä–∞—Ñ–æ–Ω"
        –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: "–í—ã—É—á–∏—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –∑–∞ 2 –º–µ—Å—è—Ü–∞"

        - **description**: —Ç–æ–ª—å–∫–æ –º–æ—Ç–∏–≤–∞—Ü–∏—è –∏–ª–∏ —É—Å–ª–æ–≤–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: "—á—Ç–æ–±—ã —É—Å—Ç—Ä–æ–∏—Ç—å—Å—è –Ω–∞ —Ä–∞–±–æ—Ç—É").
        –ï—Å–ª–∏ –µ—Å—Ç—å –≤ –∑–∞–ø—Ä–æ—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –∏–∑–≤–ª–µ–∫–∏. –ï—Å–ª–∏ –Ω–µ—Ç - –¥–æ–±–∞–≤—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ–µ –æ—Ç —Å–µ–±—è

        - **deadline**: –¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ì–ì–ì–ì-–ú–ú-–î–î.
        –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–π –û–¢–ù–û–°–ò–¢–ï–õ–¨–ù–û –°–ï–ì–û–î–ù–Ø ({today.isoformat()}):
            ‚Ä¢ "–∑–∞ X –¥–Ω–µ–π/–Ω–µ–¥–µ–ª—å/–º–µ—Å—è—Ü–µ–≤" ‚Üí –ø—Ä–∏–±–∞–≤—å –∫ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç–µ
            ‚Ä¢ "–¥–æ DD.MM" ‚Üí –∏—Å–ø–æ–ª—å–∑—É–π —Ç–µ–∫—É—â–∏–π –≥–æ–¥
            ‚Ä¢ "–∫ –∫–æ–Ω—Ü—É –≥–æ–¥–∞" ‚Üí {today.year}-12-31

        ‚ùó–í–ê–ñ–ù–û:
        - –°—Ä–æ–∫ ("–∑–∞ 2 –º–µ—Å—è—Ü–∞") –ù–ï –¥–æ–ª–∂–µ–Ω –ø–æ–ø–∞–¥–∞—Ç—å –Ω–∏ –≤ title, –Ω–∏ –≤ description.
        - –û—Ç–≤–µ—Ç –¢–û–õ–¨–ö–û –≤ JSON. –ù–∏–∫–∞–∫–∏—Ö –ø–æ—è—Å–Ω–µ–Ω–∏–π.

        –ü—Ä–∏–º–µ—Ä—ã:

        "–≤—ã—É—á–∏—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –∑–∞ 2 –º–µ—Å—è—Ü–∞"
        ‚Üí {{"title":"–í—ã—É—á–∏—Ç—å –∞–Ω–≥–ª–∏–π—Å–∫–∏–π","description":"","deadline":"{(today + timedelta(days=60)).isoformat()}"}}

        "–ø—Ä–æ–±–µ–∂–∞—Ç—å –º–∞—Ä–∞—Ñ–æ–Ω –¥–æ 15 –∏—é–Ω—è"
        ‚Üí {{"title":"–ü—Ä–æ–±–µ–∂–∞—Ç—å –º–∞—Ä–∞—Ñ–æ–Ω","description":"","deadline":"{today.year}-06-15"}}

        "–Ω–∞—É—á–∏—Ç—å—Å—è –∏–≥—Ä–∞—Ç—å –Ω–∞ –≥–∏—Ç–∞—Ä–µ, —á—Ç–æ–±—ã —É–¥–∏–≤–∏—Ç—å –¥—Ä—É–∑–µ–π"
        ‚Üí {{"title":"–ù–∞—É—á–∏—Ç—å—Å—è –∏–≥—Ä–∞—Ç—å –Ω–∞ –≥–∏—Ç–∞—Ä–µ","description":"–ß—Ç–æ–±—ã —É–¥–∏–≤–∏—Ç—å –¥—Ä—É–∑–µ–π","deadline":null}}

        –ó–∞–ø—Ä–æ—Å:
        "{user_input}"
        """

        response = self.llm.invoke(prompt)
        # üî¥ –û–¢–õ–ê–î–ö–ê: –≤—ã–≤–æ–¥–∏–º —Å—ã—Ä–æ–π –æ—Ç–≤–µ—Ç
        print("=== RAW LLM RESPONSE ===")
        print(response.content)
        print("========================")
        return GoalDraft.model_validate_json(response.content)
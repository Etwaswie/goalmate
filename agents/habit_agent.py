from models.habit import HabitAction


class HabitAgent:
    def __init__(self, llm):
        self.llm = llm

    def extract_habit_action(self, user_input: str) -> HabitAction:
        prompt = f"""
        Ты — строгий ассистент для создания привычек. ТВОЯ ЗАДАЧА — ИЗВЛЕЧЬ ДАННЫЕ БЕЗ ПОТЕРЬ.

        Из запроса пользователя извлеки:

        - **action**: "create" или "track"
        - **title**: **ПОЛНОЕ НАЗВАНИЕ ПРИВЫЧКИ**, как её сказал бы пользователь. ОБЯЗАТЕЛЬНО ВКЛЮЧИ:
            • длительность («30 минут», «1 час»)
            • объём («2 литра», «5 км»)
            • частоту/время («в день», «по утрам», «3 раза в неделю»)
            • объект («воду», «книгу», «на гитаре»)
        Примеры ХОРОШИХ title:
            → "Читать 30 минут в день"
            → "Пить 2 литра воды"
            → "Бегать 5 км по утрам"
            → "Играть на гитаре 1 час вечером"
        НИКОГДА не сокращай до одного слова!

        - **description**: только если пользователь добавил **мотивацию, условие или способ проверки**, которого нет в title.
        Пример: 
            Запрос: "хочу медитировать утром, чтобы меньше нервничать"
            → title: "Медитировать утром"
            → description: "Чтобы меньше нервничать"

        - **frequency**: "daily", "weekly" или null

        ❗ПРАВИЛА:
        1. Никаких пояснений — ТОЛЬКО JSON.
        2. Если нет описания — ставь "".
        3. Title ДОЛЖЕН быть понятен сам по себе.

        Примеры:

        "хочу каждый день выпивать по 2 литра воды"
        → {{"action":"create","title":"Пить 2 литра воды в день","description":"","frequency":"daily"}}

        "хочу читать 30 минут перед сном"
        → {{"action":"create","title":"Читать 30 минут перед сном","description":"","frequency":"daily"}}

        "сегодня сделал зарядку 20 минут"
        → {{"action":"track","title":"Сделать зарядку 20 минут","description":"","frequency":null}}

        Запрос:
        "{user_input}"
        """

        response = self.llm.invoke(prompt)
        return HabitAction.model_validate_json(response.content)
